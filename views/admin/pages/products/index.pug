extends ../../layout/default
include ../../mixins/box-head.pug
include ../../mixins/filterStatus.pug
include ../../mixins/search.pug
include ../../mixins/pagination.pug
include ../../mixins/form-multi-action.pug
include ../../mixins/multi-sort.pug

block main

  //- Page Header
  .d-flex.justify-content-between.align-items-center.mb-4
    div
      h2.fw-bold.mb-1
        i.bi.bi-box-seam.me-2.text-primary
        | Quản Lý Sản Phẩm
      p.text-muted.mb-0 Quản lý danh sách sản phẩm của cửa hàng
    if role.permissions.includes("products_create")
      a.btn.btn-primary(href=`${prefixAdmin}/products/create`)
        i.bi.bi-plus-circle.me-2
        | Thêm Sản Phẩm

  //- Filter & Search
  .card.mb-3.border-0.shadow-sm
    .card-header.bg-white
      h6.mb-0.fw-semibold
        i.bi.bi-funnel.me-2
        | Bộ Lọc & Tìm Kiếm
    .card-body
      .row.g-3
        .col-md-7
          +filterStatus(status, [
            { label: "Còn hàng", value: "In Stock" },
            { label: "Hết hàng", value: "Low Stock" }
          ])
        .col-md-5
          +search(keyword)

  //- Sort
  .card.mb-3.border-0.shadow-sm
    .card-header.bg-white
      h6.mb-0.fw-semibold
        i.bi.bi-sort-down.me-2
        | Sắp Xếp
    .card-body
      +multi-sort([
        { value: "position-desc", name: "vị trí giảm dần" },
        { value: "position-asc", name: "vị trí tăng dần" },
        { value: "price-desc", name: "giá giảm dần" },
        { value: "price-asc", name: "giá tăng dần" },
        { value: "title-asc", name: "tiêu đề A - Z" },
        { value: "title-desc", name: "tiêu đề Z - A" }
      ])

  //- Products List
  .card.border-0.shadow-sm
    .card-header.bg-white.d-flex.justify-content-between.align-items-center
      h6.mb-0.fw-semibold
        i.bi.bi-list-ul.me-2
        | Danh Sách Sản Phẩm
      span.badge.bg-primary #{listProduct.length} sản phẩm

    .card-body
      //- Toolbar
      .row.g-3.mb-3
        .col-md-6
          if role.permissions.includes("products_edit")
            +form-multi-action(
                [
                  {value: "In Stock",name:"còn hàng"},
                  {value: "Low Stock",name:"hết hàng"},
                  {value: "delete",name:"xóa sản phẩm"},
                  {value: "Change position",name:"thay đổi vị trí"},
                ],
                `${prefixAdmin}/products/change-multi?_method=PATCH`
              )
        .col-md-6.text-end
          .btn-group
            button.btn.btn-sm.btn-outline-secondary(type="button")
              i.bi.bi-grid-3x3-gap
            button.btn.btn-sm.btn-outline-secondary.active(type="button")
              i.bi.bi-list-ul

      //- Table
      .table-responsive
        table.table.table-hover.align-middle(checkbox-multi)
          thead.table-light
            tr
              th.text-center(style="width: 50px")
                input.form-check-input(type="checkbox" name="check-change-all")
              th.text-center STT
              th.text-center Hình Ảnh
              th Tiêu Đề
              th.text-center Giá
              th.text-center Vị Trí
              th.text-center Trạng Thái
              th Cập nhật gần đây
              th.text-center Thao Tác

          tbody
            if listProduct.length === 0
              tr
                td.text-center.py-5(colspan="8")
                  i.bi.bi-inbox.display-1.text-muted.d-block
                  p.text-muted Không có sản phẩm
            else
              each item, index in listProduct
                tr
                  td.text-center
                    input.form-check-input(type="checkbox" value=item._id name="check-change")
                  td.text-center.fw-semibold #{(pagination.currentPage-1)*pagination.limitPage + index +1}
                  td.text-center
                    img.rounded.border(
                      src=item.thumbnail
                      alt=item.title
                      style="width: 60px; height: 60px; object-fit: cover;"
                    )
                  td
                    .fw-semibold #{item.title}
                    if item.description
                      //- small.text-muted.d-block.text-truncate(style="max-width: 300px") !{item.description}
                  td.text-center
                    span.fw-bold.text-success #{item.price}$
                  td.text-center
                    input.form-control.form-control-sm.text-center(
                      type="number"
                      style="width: 70px"
                      name="position"
                      min="1"
                      data-id=item._id
                      value=item.position
                    )
                  td.text-center
                    button.badge.border-0.fs-6(
                      class=item.availabilityStatus === "In Stock" ? "bg-success" : "bg-danger"
                      data-status=item.availabilityStatus
                      data-id=item._id
                      btn-change-status
                    )
                      i.bi(class=item.availabilityStatus === "In Stock" ? "bi-check-circle" : "bi-x-circle")
                      |  #{item.availabilityStatus}
                  td 
                    .fw-normal #{item.updatedByFullName}
                    .fw-normal #{new Date(item.updatedAt).toLocaleDateString("vi-VN")}
                  td.text-center
                    .btn-group.btn-group-sm
                      a.btn.btn-outline-info(
                        href=`${prefixAdmin}/products/detail/${item._id}`
                        title="Chi tiết"
                      )
                        i.bi.bi-eye
                      if role.permissions.includes("products_edit")
                        a.btn.btn-outline-warning(
                          href=`${prefixAdmin}/products/edit/${item._id}`
                          title="Sửa"
                        )
                          i.bi.bi-pencil
                      if role.permissions.includes("products_delete")
                        button.btn.btn-outline-danger(
                          btn-delete
                          data-id=item._id
                          title="Xóa"
                        )
                          i.bi.bi-trash

  //- Pagination
  .mt-4
    +pagination(pagination)

  //- Hidden Forms
  form#form-change-status(
    action=""
    method="POST"
    data-path=`${prefixAdmin}/products/change-status`
  )
  form#form-delete(
    action=""
    method="POST"
    data-path=`${prefixAdmin}/products/delete`
  )
  
  script(src="/admin/js/product.js")