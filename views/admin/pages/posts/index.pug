extends ../../layout/default
include ../../mixins/box-head.pug
include ../../mixins/filterStatus.pug
include ../../mixins/search.pug
include ../../mixins/pagination.pug
include ../../mixins/form-multi-action.pug
include ../../mixins/alert.pug
include ../../mixins/multi-sort.pug

block main
  +alert-success(5000)
  +alert-error(5000)
  
  //- Page Header
  .d-flex.justify-content-between.align-items-center.mb-4
    div
      h2.fw-bold.mb-1
        i.bi.bi-file-earmark-richtext.me-2.text-primary
        | Quản Lý Bài Viết
      p.text-muted.mb-0 Xem, sửa và xuất bản nội dung tin tức/blog
    if role.permissions.includes("posts_create")
      a.btn.btn-primary(href=`${prefixAdmin}/posts/create`)
        i.bi.bi-pencil-square.me-2
        | Viết Bài Mới

  //- Filter & Search
  .card.mb-3.border-0.shadow-sm
    .card-header.bg-white
      h6.mb-0.fw-semibold
        i.bi.bi-funnel.me-2
        | Bộ Lọc & Tìm Kiếm
    .card-body
      .row.g-3
        .col-md-7
          +filterStatus(status, [
              { label: "Hoạt động", value: "active" },
              { label: "Ngưng hoạt động", value: "inactive" }
          ])
        .col-md-5
          +search(keyword)

  //- Sort
  .card.mb-3.border-0.shadow-sm
    .card-header.bg-white
      h6.mb-0.fw-semibold
        i.bi.bi-sort-down.me-2
        | Sắp Xếp
    .card-body
      +multi-sort([
        { value: "position-desc", name: "vị trí giảm dần" },
        { value: "position-asc", name: "vị trí tăng dần" },
        { value: "title-asc", name: "tiêu đề A - Z" },
        { value: "title-desc", name: "tiêu đề Z - A" },
        { value: "createdAt-desc", name: "mới nhất" },
        { value: "createdAt-asc", name: "cũ nhất" }
      ])

  //- Posts List
  .card.border-0.shadow-sm
    .card-header.bg-white.d-flex.justify-content-between.align-items-center
      h6.mb-0.fw-semibold
        i.bi.bi-list-stars.me-2
        | Danh Sách Bài Viết
      span.badge.bg-primary #{listPosts.length} bài viết

    .card-body
      //- Toolbar
      .row.g-3.mb-3
        .col-md-6
          if role.permissions.includes("posts_edit")
            +form-multi-action(
                [
                  {value: "active",name:"hiển thị"},
                  {value: "inactive",name:"bản nháp"},
                  {value: "delete",name:"xóa bài viết"},
                  {value: "Change position",name:"thay đổi vị trí"},
                ],
                `${prefixAdmin}/posts/change-multi?_method=PATCH`
              )
        .col-md-6.text-end
          .btn-group
            button.btn.btn-sm.btn-outline-secondary(type="button")
              i.bi.bi-grid
            button.btn.btn-sm.btn-outline-secondary.active(type="button")
              i.bi.bi-list-ul

      //- Table
      .table-responsive
        table.table.table-hover.align-middle(checkbox-multi)
          thead.table-light
            tr
              th.text-center(style="width: 50px")
                input.form-check-input(type="checkbox" name="check-change-all")
              th.text-center STT
              th.text-center Hình Ảnh
              th Tiêu Đề
              th.text-center Nổi bật
              th.text-center Vị Trí
              th.text-center Trạng Thái
              th Người đăng
              th.text-center Thao Tác

          tbody
            if listPosts.length === 0
              tr
                td.text-center.py-5(colspan="9")
                  i.bi.bi-journal-x.display-1.text-muted.d-block
                  p.text-muted Không có bài viết nào được tìm thấy
            else
              each item, index in listPosts
                tr
                  td.text-center
                    input.form-check-input(type="checkbox" value=item._id name="check-change")
                  td.text-center.fw-semibold #{index +1}
                  td.text-center
                    img.rounded.border(
                      src=item.thumbnail
                      alt=item.title
                      style="width: 80px; height: 50px; object-fit: cover;"
                    )
                  td
                    .fw-semibold.text-primary #{item.title}
                    if item.post_category_title
                       small.badge.bg-light.text-dark.border.me-1 #{item.post_category_title}
                  td.text-center
                    if item.featured === "1"
                      span.badge.bg-warning.text-dark
                        i.bi.bi-star-fill.me-1
                        | Nổi bật
                    else
                      span.text-muted -
                  td.text-center
                    input.form-control.form-control-sm.text-center(
                      type="number"
                      style="width: 65px; margin: 0 auto;"
                      name="position"
                      min="1"
                      data-id=item._id
                      value=item.position
                    )
                  td.text-center
                    button.badge.border-0.fs-6(
                      class=item.status === "active" ? "bg-success" : "bg-secondary"
                      data-status=item.status
                      data-id=item._id
                      btn-change-status
                    )
                      i.bi(class=item.status === "active" ? "bi-eye-fill" : "bi-eye-slash-fill")
                      |  #{item.status === "active" ? "Hiển thị" : "Bản nháp"}
                  td 
                    .fw-normal #{item.createdByFullName}
                    small.text-muted #{new Date(item.createdAt).toLocaleDateString("vi-VN")}
                  td.text-center
                    .btn-group.btn-group-sm
                      a.btn.btn-outline-info(
                        href=`${prefixAdmin}/posts/detail/${item._id}`
                        title="Xem chi tiết"
                      )
                        i.bi.bi-file-earmark-text
                      if role.permissions.includes("posts_edit")
                        a.btn.btn-outline-warning(
                          href=`${prefixAdmin}/posts/edit/${item._id}`
                          title="Chỉnh sửa bài"
                        )
                          i.bi.bi-pencil
                      if role.permissions.includes("posts_delete")
                        button.btn.btn-outline-danger(
                          btn-delete
                          data-id=item._id
                          title="Xóa bài viết"
                        )
                          i.bi.bi-trash

  //- Pagination
  .mt-4
    +pagination(pagination)

  //- Hidden Forms
  form#form-change-status(
    action=""
    method="POST"
    data-path=`${prefixAdmin}/posts/change-status`
  )
  form#form-delete(
    action=""
    method="POST"
    data-path=`${prefixAdmin}/posts/delete`
  )
  
  //- Đừng quên tạo file JS tương ứng hoặc dùng chung logic với product
  script(src="/admin/js/post.js")