extends ../../layout/default
include ../../mixins/box-head.pug
include ../../mixins/filterStatus.pug
include ../../mixins/search.pug
include ../../mixins/pagination.pug
include ../../mixins/form-multi-action.pug
include ../../mixins/multi-sort.pug

block main
  .d-flex.justify-content-between.align-items-center.mb-4
    div
      h2.fw-bold.mb-1
        i.bi.bi-cart.me-2.text-primary
        | Quản Lý Đơn Hàng
      p.text-muted.mb-0 Quản lý danh sách đơn hàng của cửa hàng

  .card.mb-3.border-0.shadow-sm
    .card-header.bg-white
      h6.mb-0.fw-semibold
        i.bi.bi-funnel.me-2
        | Bộ Lọc & Tìm Kiếm
    .card-body
      .row.g-3
        .col-md-7
          +filterStatus(currentStatus, [
            { label: "Chờ xác nhận", value: "pending" },
            { label: "Xác nhận", value: "confirmed" },
            { label: "Đang giao", value: "shipping" }, 
            { label: "Hoàn thành", value: "completed" },
            { label: "Đã hủy", value: "cancelled" }
          ])
        .col-md-5
          +search(keyword)

  .card.mb-3.border-0.shadow-sm
    .card-header.bg-white
      h6.mb-0.fw-semibold
        i.bi.bi-sort-down.me-2
        | Sắp Xếp
    .card-body
      +multi-sort([
        { value: "createdAt-desc", name: "Mới nhất" },
        { value: "createdAt-asc", name: "Cũ nhất" },
        { value: "totalPrice-desc", name: "Giá giảm dần" },
        { value: "totalPrice-asc", name: "Giá tăng dần" }
      ])

  .card.border-0.shadow-sm
    .card-header.bg-white.d-flex.justify-content-between.align-items-center
      h6.mb-0.fw-semibold
        i.bi.bi-list-ul.me-2
        | Danh Sách đơn hàng
      span.badge.bg-primary #{listOrder.length} đơn hàng

    .card-body
      //- Toolbar
      //- .row.g-3.mb-3
      //-   .col-md-6
      //-       +form-multi-action(
      //-           [
      //-             { value: "pending", name: "Chờ xác nhận"},
      //-             { value: "confirmed", name: "Xác nhận"},
      //-             { value: "shipping", name: "Đang giao"},
      //-             { value: "completed",name: "Hoàn thành"  },
      //-             { value: "cancelled", name: "Đã hủy" }
      //-           ],
      //-           `${prefixAdmin}/orders/change-multi?_method=PATCH`
      //-         )
      //-   .col-md-6.text-end
      .table-responsive
        table.table.table-hover.align-middle(checkbox-multi)
          thead.table-light
            tr
              th.text-center(style="width: 50px")
                input.form-check-input(type="checkbox" name="check-change-all")
              th.text-center STT
              th.text-center Mã đơn
              th Người mua
              th Ngày đặt
              th.text-center SL
              th.text-center Tổng tiền
              th.text-center Trạng thái 
              th.text-center Thao tác

          tbody
            if listOrder.length === 0
              tr
                td.text-center.py-5(colspan="8")
                  i.bi.bi-inbox.display-1.text-muted.d-block
                  p.text-muted Không có đơn hàng nào
            else
              each item, index in listOrder
                tr
                  td.text-center
                    input.form-check-input(type="checkbox" value=item._id name="check-change")
                  td.text-center.fw-semibold #{(pagination.currentPage-1)*pagination.limitPage + index +1}
                  td.text-center 
                    span.text-muted #{item._id.toString()} 
                  td
                    .fw-semibold #{item.userInfor.fullName}
                    div.small.text-muted #{item.userInfor.phone} 
                  td #{new Date(item.createdAt).toLocaleDateString('vi-VN')}
                    br
                    small.text-muted #{new Date(item.createdAt).toLocaleTimeString('vi-VN')}
                  td.text-center #{item.totalQuantity}
                  td.text-center
                    .fw-bold.text-danger #{item.totalPrice}$
                    
                  td.text-center 
                    if status[item.status]
                      button.badge.border-0.fs-6(
                        class=status[item.status].buttonColor
                        data-status=item.status
                        data-id=item._id
                        btn-change-status
                      )
                        i.bi(class=status[item.status].icon)
                        |  #{status[item.status].label}
                    else 
                      span.badge.bg-secondary #{item.status}

                  td.text-center
                    .btn-group.btn-group-sm
                      a.btn.btn-outline-info(
                        href=`${prefixAdmin}/orders/detail/${item._id}`
                        title="Chi tiết"
                      )
                        i.bi.bi-eye 
                        | chi tiết  
                      //- Logic xóa mềm hoặc hủy đơn nên cân nhắc kỹ ở đây
                      //- if role.permissions.includes("orders_delete")
                      button.btn.btn-outline-danger(
                        btn-delete
                        data-id=item._id
                        title="Hủy đơn hàng"
                      )
                        i.bi.bi-x-circle 
                        | hủy đơn 

  //- Pagination
  .mt-4
    +pagination(pagination)

  form#form-change-status(
    action=""
    method="POST"
    data-path=`${prefixAdmin}/orders/change-status`
  )
  form#form-delete(
    action=""
    method="POST"
    data-path=`${prefixAdmin}/orders/delete`
  )
  
  script(src="/admin/js/order.js")